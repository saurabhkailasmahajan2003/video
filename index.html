<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>P2P Video Call</title>
  <style>
    video { width: 45%; margin: 5px; border: 2px solid #444; border-radius: 8px; }
    #buttons { margin-top: 10px; }
    input { width: 250px; padding: 5px; }
  </style>
</head>
<body>
  <h2>Peer-to-Peer Video Call (Firebase + WebRTC)</h2>

  <video id="localVideo" autoplay playsinline muted></video>
  <video id="remoteVideo" autoplay playsinline></video>

  <div id="buttons">
    <button id="startBtn">Start Call</button>
    <input id="callIdInput" placeholder="Enter Call ID">
    <button id="joinBtn">Join Call</button>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js"></script>

  <script>
    // ðŸ”¥ Replace with your Firebase config
    const firebaseConfig = {
  apiKey: "AIzaSyAbpNAYCG-0q7kQu8i37vx0yJGvzOg3AwA",
  authDomain: "login-page-bd3a2.firebaseapp.com",
  databaseURL: "https://login-page-bd3a2-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "login-page-bd3a2",
  storageBucket: "login-page-bd3a2.firebasestorage.app",
  messagingSenderId: "37176032229",
  appId: "1:37176032229:web:2a9e2afa02b2b2add70d0c",
  measurementId: "G-7XE3CV40FZ"
};

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const servers = { iceServers: [{ urls: ["stun:stun.l.google.com:19302"] }] };
    let pc = new RTCPeerConnection(servers);
    let localStream, remoteStream;

    const localVideo = document.getElementById("localVideo");
    const remoteVideo = document.getElementById("remoteVideo");
    const startBtn = document.getElementById("startBtn");
    const joinBtn = document.getElementById("joinBtn");
    const callIdInput = document.getElementById("callIdInput");

    async function initMedia() {
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
      localVideo.srcObject = localStream;

      remoteStream = new MediaStream();
      pc.ontrack = event => {
        event.streams[0].getTracks().forEach(track => remoteStream.addTrack(track));
        remoteVideo.srcObject = remoteStream;
      };
    }

    // ðŸ“Œ Create call
    startBtn.onclick = async () => {
      await initMedia();
      const callRef = db.ref("calls").push();
      const callId = callRef.key;
      alert("Your Call ID: " + callId);

      pc.onicecandidate = event => {
        if (event.candidate) {
          callRef.child("offerCandidates").push(event.candidate.toJSON());
        }
      };

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      await callRef.child("offer").set(offer);

      // listen for answer
      callRef.child("answer").on("value", async snapshot => {
        const answer = snapshot.val();
        if (answer && !pc.currentRemoteDescription) {
          await pc.setRemoteDescription(new RTCSessionDescription(answer));
        }
      });

      // listen for answer ICE candidates
      callRef.child("answerCandidates").on("child_added", snapshot => {
        const candidate = new RTCIceCandidate(snapshot.val());
        pc.addIceCandidate(candidate);
      });
    };

    // ðŸ“Œ Join call
    joinBtn.onclick = async () => {
      const callId = callIdInput.value;
      if (!callId) {
        alert("Please enter a valid Call ID.");
        return;
      }
      await initMedia();
      const callRef = db.ref("calls/" + callId);

      pc.onicecandidate = event => {
        if (event.candidate) {
          callRef.child("answerCandidates").push(event.candidate.toJSON());
        }
      };

      const snapshot = await callRef.child("offer").get();
      if (!snapshot.exists()) {
        alert("Call ID not found or offer not yet created.");
        return;
      }

      const offer = snapshot.val();
      await pc.setRemoteDescription(new RTCSessionDescription(offer));

      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      await callRef.child("answer").set(answer);

      // listen for offer ICE candidates
      callRef.child("offerCandidates").on("child_added", snapshot => {
        const candidate = new RTCIceCandidate(snapshot.val());
        pc.addIceCandidate(candidate);
      });
    };
  </script>
</body>
</html>
