<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Firebase P2P Video Call</title>
  <style>
    body {
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 20px;
      background: #f0f2f5;
    }
    .video-container {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }
    video {
      width: 320px;
      height: 240px;
      background: #333;
      border: 1px solid #ccc;
    }
    .controls { margin-bottom: 20px; }
    button {
      padding: 10px 15px;
      margin: 5px;
      font-size: 16px;
      cursor: pointer;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
    }
    input[type="text"] {
      padding: 8px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <h1>Peer-to-Peer Video Call</h1>

  <div class="video-container">
    <video id="localVideo" autoplay muted></video>
    <video id="remoteVideo" autoplay></video>
  </div>

  <div class="controls">
    <button id="createCall">Create Call</button>
    <input type="text" id="callIdInput" placeholder="Enter Call ID">
    <button id="joinCall">Join Call</button>
    <button id="hangup">Hang Up</button>
  </div>

  <p>Call ID: <span id="currentCallId"></span></p>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import { getDatabase, ref, set, push, child, onValue, get } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js";

    // ðŸ”¹ Replace with your Firebase config
    const firebaseConfig = {
  apiKey: "AIzaSyAbpNAYCG-0q7kQu8i37vx0yJGvzOg3AwA",
  authDomain: "login-page-bd3a2.firebaseapp.com",
  databaseURL: "https://login-page-bd3a2-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "login-page-bd3a2",
  storageBucket: "login-page-bd3a2.firebasestorage.app",
  messagingSenderId: "37176032229",
  appId: "1:37176032229:web:2a9e2afa02b2b2add70d0c",
  measurementId: "G-7XE3CV40FZ"
};

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // DOM elements
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    const createCallBtn = document.getElementById('createCall');
    const joinCallBtn = document.getElementById('joinCall');
    const hangupBtn = document.getElementById('hangup');
    const callIdInput = document.getElementById('callIdInput');
    const callIdSpan = document.getElementById('currentCallId');

    let localStream = null;
    let pc = null;
    let currentCallId = null;

    const config = {
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' },
      ]
    };

    async function getMedia() {
      if (!localStream) {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        localVideo.srcObject = localStream;
      }
    }

    function createPeerConnection() {
      pc = new RTCPeerConnection(config);
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

      pc.ontrack = (event) => {
        if (remoteVideo.srcObject !== event.streams[0]) {
          remoteVideo.srcObject = event.streams[0];
        }
      };
    }

    // ðŸ“ž Create Call
    createCallBtn.onclick = async () => {
      await getMedia();
      createPeerConnection();

      const callRef = push(ref(db, "calls"));
      currentCallId = callRef.key;
      callIdSpan.textContent = currentCallId;

      const offerCandidates = child(callRef, "offerCandidates");
      const answerCandidates = child(callRef, "answerCandidates");

      pc.onicecandidate = (event) => {
        if (event.candidate) {
          push(offerCandidates, event.candidate.toJSON());
        }
      };

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      await set(child(callRef, "offer"), offer);

      onValue(child(callRef, "answer"), async (snapshot) => {
        const answer = snapshot.val();
        if (answer && !pc.currentRemoteDescription) {
          await pc.setRemoteDescription(new RTCSessionDescription(answer));
        }
      });

      onValue(answerCandidates, async (snapshot) => {
        snapshot.forEach(childSnap => {
          const candidate = childSnap.val();
          pc.addIceCandidate(new RTCIceCandidate(candidate));
        });
      });
    };

    // ðŸ“ž Join Call
    joinCallBtn.onclick = async () => {
      await getMedia();
      currentCallId = callIdInput.value;
      if (!currentCallId) {
        alert("Enter Call ID");
        return;
      }
      callIdSpan.textContent = currentCallId;

      const callRef = ref(db, "calls/" + currentCallId);
      const offerSnap = await get(child(callRef, "offer"));
      if (!offerSnap.exists()) {
        alert("Call ID not found or offer not yet available.");
        return;
      }

      createPeerConnection();
      const offer = offerSnap.val();
      await pc.setRemoteDescription(new RTCSessionDescription(offer));

      const answerCandidates = child(callRef, "answerCandidates");
      const offerCandidates = child(callRef, "offerCandidates");

      pc.onicecandidate = (event) => {
        if (event.candidate) {
          push(answerCandidates, event.candidate.toJSON());
        }
      };

      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      await set(child(callRef, "answer"), answer);

      onValue(offerCandidates, async (snapshot) => {
        snapshot.forEach(childSnap => {
          const candidate = childSnap.val();
          pc.addIceCandidate(new RTCIceCandidate(candidate));
        });
      });
    };

    // ðŸ“´ Hang Up
    hangupBtn.onclick = () => {
      if (pc) {
        pc.close();
        pc = null;
      }
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
      }
      localVideo.srcObject = null;
      remoteVideo.srcObject = null;
      callIdSpan.textContent = "";
    };
  </script>
</body>
</html>
